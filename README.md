# mobile-companion-for-performance

## Introduction

This is an experimental [MCP server tool](https://modelcontextprotocol.io/docs/concepts/tools) which enables users to use natural language with MCP-enabled chatbots to:

1. Record startup traces of their .NET Android apps.
2. Analyze the traces and get relevant method information from them (similar to PerfView).

> NOTE: The analysis aspect is currently limited to displaying method information like (JIT time, IL size, native size and timestamp), but can be easily extended.

The main advantage of the tools is simplification of the above tasks and providing more context about the application behavior to the AI agent and help with reasoning.

## Using the MCP tool

### Prerequisites

- dotnet-sdk `9.0.100`
- dotnet-trace `9.0.621003+ebd1db46a2395bd7de706694ff54f1c9526951d7`
- dotnet-dsrouter `9.0.621003+ebd1db46a2395bd7de706694ff54f1c9526951d7`
- ANDROID_NDK `27.2.12479018`
- VSCode `1.99.3` (with GitHub Copilot - Agent mode + GPT-4o model)
- Connected physical Android devices

### Starting the server

- From repo root run `dotnet run --project MC4P/MC4P.csproj`

### Configuring the agent

- Open VSCode and Copilot chat
- Click the tool icon in the char and select `Add MCP server`
- Select `HTTP`
- Enter `http://localhost:3001/sse`
- Choose a name like `mc4p`
- This should add the following in `settings.json` file:

```json
"mcp": {
    "servers": {
        "mc4p": {
            "type": "sse",
            "url": "http://localhost:3001/sse"
        }
    }
}
```

- The tool icon should display the number of available tools (7)

### Using the tool

- Open an android project and use the following prompt to run the exposed methods:

```txt
Record new startup trace of .NET Android app using MobileCompanionForPerformance tool
```

- This should invoke `RecordStartupTraceOnAndroid` method on the server and start the sequence of actions that will lead to recording a startup trace and examining the collected information from it.

## Implementation

Most of the C# code was generated by GitHub Copilot in agend mode using `Claude 3.7 Sonnet` model.
https://github.com/modelcontextprotocol/csharp-sdk was used to create .NET MCP server.

### Available tools

- `RecordStartupTraceOnAndroid` - top-level tool which automates the whole process of recording the profile and extracting information from it
- `ConfigureAndroidProjectForTracing` - configures the currently selected project for startup tracing on Android
- `CleanAndroidProjectForTracing` - cleans the project
- `BuildAndroidProjectForTracing` - builds the project for startup tracing
- `RunTracing` - uses `dotnet-dsrouter`, `dotnet-trace` to record startup trace and `adb` to install apps apk on the target device and open it
- `ListNMethods` - parses recorded nettrace file and list top N methods (methods can be sorted by size, JIT time and time to reach)
- `DisplayMethodStats` - parses recorded nettrace file and displays information about methods matching the desired name

## Validation

The generated output was manually validated by comparing the extracted information by the tool and what is shown in PerfView for the same nettrace file.
